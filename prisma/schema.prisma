generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Branch {
  id        String     @id @default(cuid())
  name      String
  code      String     @unique
  address   String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  employees Employee[]
  orders    Order[]
  users     User[]
  machines  Machine[]
  stockTransfersFrom StockTransfer[]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(OPERATOR)
  branchId   String?
  employeeId String?  @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  branch     Branch?  @relation(fields: [branchId], references: [id])
  employee   Employee? @relation(fields: [employeeId], references: [id])
  stockTransactions StockTransaction[]
  managedStore       Store?            @relation("StoreManager")
  posTransactions    POSTransaction[]
  transfersOut       StockTransfer[]   @relation("Transferrer")
  transfersIn        StockTransfer[]   @relation("Receiver")
}

model Employee {
  id             String            @id @default(cuid())
  name           String
  designation    String
  phone          String?
  gpsCoordinates String?
  branchId       String
  department     String?           // Department/Phase (e.g., "CUTTING", "WELDING")
  assignedStages ProductionStage[] // Stages this operator can work on
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  attendance     Attendance[]
  branch         Branch            @relation(fields: [branchId], references: [id])
  productionLogs ProductionLog[]
  user           User?
  breaks         Break[]
  leaveRequests  LeaveRequest[]
  wastageLogs    WastageLog[]
  machineReports MachineStatus[]   @relation("MachineReporter")
  machineResolved MachineStatus[]  @relation("MachineResolver")
  productionEntries ProductionEntry[] @relation("ProductionOperator")
  approvedProductions ProductionEntry[] @relation("ProductionApprover")
  materialConsumptions MaterialConsumption[] @relation("MaterialConsumer")
}

model Attendance {
  id         String    @id @default(cuid())
  employeeId String
  date       DateTime  @default(now())
  checkIn    DateTime
  checkOut   DateTime?
  location   String?
  status     String    @default("PRESENT")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  employee   Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model Order {
  id              String          @id @default(cuid())
  orderNumber     String          @unique
  customerName    String
  customerPhone   String?
  customerAddress String?
  status          OrderStatus     @default(PENDING)
  currentStage    ProductionStage @default(PENDING)
  branchId        String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  invoices        Invoice[]
  branch          Branch?         @relation(fields: [branchId], references: [id])
  items           OrderItem[]
  productionLogs  ProductionLog[]
  wastageLogs     WastageLog[]
  productionEntries ProductionEntry[]
  materialConsumptions MaterialConsumption[]
  stockTransfers  StockTransfer[]
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productName String
  quantity    Int
  dimensions  String?
  material    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  order       Order    @relation(fields: [orderId], references: [id])
}

model ProductionLog {
  id         String          @id @default(cuid())
  orderId    String
  stage      ProductionStage
  status     String
  employeeId String?
  notes      String?
  timestamp  DateTime        @default(now())
  employee   Employee?       @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  order      Order           @relation(fields: [orderId], references: [id])
}

model Invoice {
  id          String   @id @default(cuid())
  invoiceNo   String   @unique
  orderId     String
  amount      Float
  gstAmount   Float    @default(0)
  isGst       Boolean  @default(false)
  status      String
  generatedAt DateTime @default(now())
  order       Order    @relation(fields: [orderId], references: [id])
}

enum Role {
  ADMIN
  BRANCH_MANAGER
  PRODUCTION_SUPERVISOR
  OPERATOR
  ORDER_TAKER
  ACCOUNTANT
  STORE_MANAGER
  MARKETING_HEAD
}

enum ProductionStage {
  PENDING
  CUTTING
  SHAPING
  BENDING
  WELDING_INNER
  WELDING_OUTER
  GRINDING
  FINISHING
  PAINTING
  PLYWOOD_FITTING
  COMPLETED
}

enum OrderStatus {
  PENDING
  APPROVED
  IN_PRODUCTION
  COMPLETED
  DELIVERED
  CANCELLED
}

model InventoryItem {
  id                String              @id @default(cuid())
  name              String
  sku               String              @unique
  category          String
  quantity          Float
  unit              String
  reorderLevel      Float?
  price             Float?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  stockTransactions StockTransaction[]
  materialConsumptions MaterialConsumption[]
}

model StockTransaction {
  id        String        @id @default(cuid())
  itemId    String
  quantity  Float
  type      StockTxType
  userId    String
  timestamp DateTime      @default(now())
  item      InventoryItem @relation(fields: [itemId], references: [id])
  user      User          @relation(fields: [userId], references: [id])
}

enum StockTxType {
  IN
  OUT
  ADJUSTMENT
}

model Break {
  id         String    @id @default(cuid())
  employeeId String
  startTime  DateTime  @default(now())
  endTime    DateTime?
  duration   Int?      // in minutes
  reason     String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  employee   Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model LeaveRequest {
  id         String      @id @default(cuid())
  employeeId String
  leaveType  LeaveType
  startDate  DateTime
  endDate    DateTime
  reason     String
  status     LeaveStatus @default(PENDING)
  approvedBy String?
  approvedAt DateTime?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  employee   Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

enum LeaveType {
  CASUAL
  SICK
  EARNED
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model WastageLog {
  id           String          @id @default(cuid())
  employeeId   String
  orderId      String?
  materialName String
  quantity     Float
  unit         String
  reason       String
  stage        ProductionStage
  photoUrl     String?
  timestamp    DateTime        @default(now())
  employee     Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  order        Order?          @relation(fields: [orderId], references: [id])
}

model MachineStatus {
  id          String       @id @default(cuid())
  machineId   String?      // Link to Machine model (optional for backward compatibility)
  machineName String       // Keep for legacy/manual entries
  status      MachineState @default(OPERATIONAL)
  issue       String?
  priority    Priority     @default(MEDIUM)
  reportedBy  String
  resolvedBy  String?
  reportedAt  DateTime     @default(now())
  resolvedAt  DateTime?
  stage       ProductionStage
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  machine     Machine?     @relation("MachineMaster", fields: [machineId], references: [id])
  reporter    Employee     @relation("MachineReporter", fields: [reportedBy], references: [id], onDelete: Cascade)
  resolver    Employee?    @relation("MachineResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)
}

enum MachineState {
  OPERATIONAL
  STUCK
  MAINTENANCE
  BREAKDOWN
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum MaterialType {
  MS_SHEET
  HANDLE
  HINGE
  FLAP_DISC
  CO2_GAS
  WELDING_WIRE
  BACK_PATTI
  LOCK
  LOCK_CLIP
  PATLA
  L_PATTI
  PAINT
  POWDER
  OTHER
}

// Machine Master - Tracks all machines in the factory
model Machine {
  id              String            @id @default(cuid())
  name            String            // "Cutting Machine", "Power Press", etc.
  code            String            @unique // "CUT-01", "PP-01", etc.
  stage           ProductionStage   // Which production stage this machine belongs to
  capacity        Int?              // Units per hour (optional)
  branchId        String
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  branch          Branch            @relation(fields: [branchId], references: [id])
  productionEntries ProductionEntry[]
  machineStatuses MachineStatus[]   @relation("MachineMaster")
}

// Production Entry - Tracks operator production on each machine
model ProductionEntry {
  id                String          @id @default(cuid())
  orderId           String
  machineId         String
  operatorId        String
  stage             ProductionStage
  
  // Input/Output tracking
  inputQuantity     Int             // Units received from previous stage
  outputQuantity    Int             // Units successfully produced
  rejectedQuantity  Int             @default(0) // Defective units
  wastageQuantity   Float           @default(0) // Scrap/wastage
  wastagePercentage Float?          // Auto-calculated wastage %
  
  // Time tracking
  startTime         DateTime        @default(now())
  endTime           DateTime?
  duration          Int?            // Minutes (auto-calculated)
  
  // Material consumption (JSON array of {materialId, quantity, unit})
  materialsUsed     Json?
  
  // Quality
  qualityNotes      String?
  qualityApproved   Boolean         @default(false)
  approvedBy        String?         // Supervisor employee ID
  approvedAt        DateTime?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  order             Order           @relation(fields: [orderId], references: [id])
  machine           Machine         @relation(fields: [machineId], references: [id])
  operator          Employee        @relation("ProductionOperator", fields: [operatorId], references: [id], onDelete: Cascade)
  approver          Employee?       @relation("ProductionApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  materialConsumptions MaterialConsumption[]
}

// Material Consumption - Detailed tracking of materials used
model MaterialConsumption {
  id                String          @id @default(cuid())
  productionEntryId String?
  orderId           String
  materialId        String          // Links to InventoryItem
  materialType      MaterialType
  quantity          Float
  unit              String
  stage             ProductionStage
  consumedBy        String          // Employee ID
  consumedAt        DateTime        @default(now())
  notes             String?
  
  order             Order           @relation(fields: [orderId], references: [id])
  material          InventoryItem   @relation(fields: [materialId], references: [id])
  employee          Employee        @relation("MaterialConsumer", fields: [consumedBy], references: [id], onDelete: Cascade)
  productionEntry   ProductionEntry? @relation(fields: [productionEntryId], references: [id])
}

// ============================================
// STORE & POS MODULE
// ============================================

// Store - Retail store/showroom
model Store {
  id              String   @id @default(cuid())
  name            String
  code            String   @unique
  address         String
  phone           String?
  email           String?
  gstNumber       String?
  isActive        Boolean  @default(true)
  managerId       String?  @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  manager         User?    @relation("StoreManager", fields: [managerId], references: [id])
  inventory       StoreInventory[]
  stockTransfersTo   StockTransfer[] @relation("TransferTo")
  stockTransfersFrom StockTransfer[] @relation("TransferFrom")
  posTransactions POSTransaction[]
}

// Store Inventory - Products available in store
model StoreInventory {
  id              String   @id @default(cuid())
  storeId         String
  productName     String
  sku             String
  quantity        Int
  unit            String
  costPrice       Float
  sellingPrice    Float
  reorderLevel    Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  store           Store    @relation(fields: [storeId], references: [id])
  
  @@unique([storeId, sku])
}

// Stock Transfer - Moving goods from production to store or between stores
model StockTransfer {
  id              String              @id @default(cuid())
  transferNumber  String              @unique
  fromType        TransferSourceType
  fromBranchId    String?
  fromStoreId     String?
  toStoreId       String
  status          TransferStatus      @default(PENDING)
  orderId         String?
  notes           String?
  transferredBy   String
  receivedBy      String?
  transferredAt   DateTime            @default(now())
  receivedAt      DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  fromBranch      Branch?             @relation(fields: [fromBranchId], references: [id])
  fromStore       Store?              @relation("TransferFrom", fields: [fromStoreId], references: [id])
  toStore         Store               @relation("TransferTo", fields: [toStoreId], references: [id])
  order           Order?              @relation(fields: [orderId], references: [id])
  transferrer     User                @relation("Transferrer", fields: [transferredBy], references: [id])
  receiver        User?               @relation("Receiver", fields: [receivedBy], references: [id])
  items           StockTransferItem[]
}

enum TransferSourceType {
  PRODUCTION
  STORE
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

// Stock Transfer Items
model StockTransferItem {
  id              String        @id @default(cuid())
  transferId      String
  productName     String
  sku             String
  quantity        Int
  unit            String
  
  transfer        StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
}

// Customer - Retail customers
model Customer {
  id              String   @id @default(cuid())
  name            String
  phone           String?
  email           String?
  address         String?
  gstNumber       String?
  customerType    CustomerType @default(RETAIL)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  transactions    POSTransaction[]
}

enum CustomerType {
  RETAIL
  REGULAR
  WHOLESALE
}

// POS Transaction - Retail sales
model POSTransaction {
  id              String            @id @default(cuid())
  billNumber      String            @unique
  storeId         String
  customerId      String?
  customerName    String?
  subtotal        Float
  discount        Float             @default(0)
  taxAmount       Float             @default(0)
  totalAmount     Float
  paymentMethod   PaymentMethod
  paymentStatus   PaymentStatus     @default(COMPLETED)
  cashierId       String
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  store           Store             @relation(fields: [storeId], references: [id])
  customer        Customer?         @relation(fields: [customerId], references: [id])
  cashier         User              @relation(fields: [cashierId], references: [id])
  items           POSTransactionItem[]
  payments        Payment[]
  accountingEntry AccountingEntry?
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  MIXED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  REFUNDED
  CANCELLED
}

// POS Transaction Items
model POSTransactionItem {
  id              String         @id @default(cuid())
  transactionId   String
  productName     String
  sku             String
  quantity        Int
  unitPrice       Float
  discount        Float          @default(0)
  taxRate         Float          @default(0)
  totalPrice      Float
  
  transaction     POSTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

// Payment - Payment details for POS transactions
model Payment {
  id              String         @id @default(cuid())
  transactionId   String
  method          PaymentMethod
  amount          Float
  reference       String?
  createdAt       DateTime       @default(now())
  
  transaction     POSTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

// Accounting Entry - Double-entry bookkeeping
model AccountingEntry {
  id              String            @id @default(cuid())
  entryType       AccountingType
  transactionId   String?           @unique
  description     String
  debitAccount    String
  creditAccount   String
  amount          Float
  date            DateTime          @default(now())
  createdAt       DateTime          @default(now())
  
  transaction     POSTransaction?   @relation(fields: [transactionId], references: [id])
}

enum AccountingType {
  SALE
  PURCHASE
  EXPENSE
  TRANSFER
  ADJUSTMENT
}

// ============================================
// MARKETING HEAD MODULE
// ============================================

// Raw Material - Inventory managed by Marketing Head
model RawMaterial {
  id              String   @id @default(cuid())
  name            String
  category        String   // M.S Sheet, Handel, Hinges, etc.
  unit            String   // kg, pieces, liters, etc.
  quantity        Float    @default(0)
  reorderLevel    Float?
  currentPrice    Float?   // Latest purchase price
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  purchases       RawMaterialPurchase[]
  usage           RawMaterialUsage[]
}

// Seller - Suppliers of raw materials
model Seller {
  id          String   @id @default(cuid())
  name        String
  contact     String?
  phone       String?
  email       String?
  address     String?
  gstNumber   String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  purchases   RawMaterialPurchase[]
}

// Raw Material Purchase - Purchase records
model RawMaterialPurchase {
  id                  String   @id @default(cuid())
  sellerId            String
  materialId          String
  quantity            Float
  unit                String
  pricePerUnit        Float
  totalPrice          Float
  transportationCost  Float    @default(0)
  grandTotal          Float    // totalPrice + transportationCost
  billNumber          String?
  billDate            DateTime?
  purchaseDate        DateTime @default(now())
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  seller              Seller       @relation(fields: [sellerId], references: [id])
  material            RawMaterial  @relation(fields: [materialId], references: [id])
}

// Raw Material Usage - Track consumption
model RawMaterialUsage {
  id          String   @id @default(cuid())
  materialId  String
  quantity    Float
  unit        String
  usedFor     String?  // Purpose/Project
  usedBy      String?  // Employee/Department
  notes       String?
  usedAt      DateTime @default(now())
  createdAt   DateTime @default(now())
  
  material    RawMaterial @relation(fields: [materialId], references: [id])
}

// Final Product Sale - Sales managed by Marketing Head
model FinalProductSale {
  id              String   @id @default(cuid())
  productName     String
  description     String?
  quantity        Int
  unit            String   @default("pieces")
  pricePerUnit    Float
  totalPrice      Float
  customerName    String?
  customerPhone   String?
  customerAddress String?
  saleDate        DateTime @default(now())
  paymentStatus   String   @default("PENDING") // PENDING, PAID, PARTIAL
  paidAmount      Float    @default(0)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
